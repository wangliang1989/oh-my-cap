# 计算格林函数

使用 gCAP 反演震源机制的第一步是正确计算格林函数。默认情况下，本项目中 gCAP 将 `Glib` 作为格林函数库所在目录。

## 文件说明

`Glib` 目录下包含了一个格林函数的示例 `model`。

在 `Glib/model` 目录下，有两个文件： `model` 和 `run_fk.pl` 。前者是一维地层模型文件，后者是计算该模型下的格林函数所需的脚本。

### 一维地层模型文件

一维地层模型文件的格式为：

    地层厚度  S波速度  P波速度  密度  S波Q值  P波Q值

其中，后三项可以省略：

例如 `Glib/model/model` 是一个具有四层的一维地层模型，其内容为：

     5.5 3.18 5.50 2.53 600 1200
    10.5 3.64 6.30 2.79 600 1200
    16.0 3.87 6.70 2.91 600 1200
    90.0 4.50 7.80 3.27 900 1800

### 格林函数计算脚本

`Glib/model/run_fk.pl` 中调用了 fk 程序以实现格林函数的计算。关于 fk 的详细用法，请参考 [fk用法笔记](https://seisman.info/fk-notes.html) 。

示例脚本 `Glib/model/run_fk.pl` 计算的格林函数参数如下：

| 参数             | 值                                  |
|------------------|-------------------------------------|
| 模型文件         | model                               |
| 震源             | 双力偶源和爆炸源                    |
| 震中距范围       | 5 - 415 km，间隔 5 km               |
| 深度             | 5 - 30 km，间隔 5 km                |
| 数据点数(npts)   | 512                                 |
| 采样间隔(dt)     | 0.2                                 |

## 计算示例格林函数

运行脚本 `run_fk.pl` 即可计算得到示例所需的格林函数。

    $ perl run_fk.pl

## 格林函数库

执行完 `run_fk.pl` 后会得到 6 个名为 `model_xx`（`xx` 代表震源深度）的文件夹，其中包含了震源深度取不同值所对应的格林函数。

以 `model_05` 目录为例，其中包含了众多文件名为 `xxx.grn.x` 的格林函数文件。其中：

- `xxx` 代表震中距
- `x` 取0-8，对应双力偶震源的9个格林函数分量
- `x` 取a、b、c，对应爆炸源的3个格林函数分量

所有格林函数均是 SAC 格式，其中 `xxx.grn.0` 和 `xxx.grn.5` 的SAC 头段 `t1` 和 `t2` 中分别保存了初至 P 波和 初至 S 波的到时，SAC 头段 `user1` 和 `user2` 中保存了初至 P 波和初至 S 波的离源角（相对于垂直向下方向旋转的角度)。

gCAP 可以根据 SAC 头段 `t1` 和 `t2` 的值自动确定要截取的波形时间窗；若反演中需要使用震相初动极性信息，则需要从 SAC 头段 `user1` 和 `user2` 中读取震相离源角。
